name: build-and-release-vox8-multiarch

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write    # needed to create releases & upload assets

env:
  # pinned SDL release (discovered from libsdl-org releases page)
  SDL_VERSION: "3.4.0"
  SDL_TARBALL: "SDL3-${{ env.SDL_VERSION }}.tar.gz"
  SDL_RELEASE_URL: "https://github.com/libsdl-org/SDL/releases/download/release-${{ env.SDL_VERSION }}/SDL3-${{ env.SDL_VERSION }}.tar.gz"

concurrency:
  group: vox8-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build (matrix)
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: armv7
            image: dockcross/linux-armv7
            triple: arm-linux-gnueabihf
          - name: aarch64
            image: dockcross/linux-arm64
            triple: aarch64-linux-gnu
          - name: i386
            image: dockcross/linux-x86
            triple: i386-linux-gnu
          - name: amd64
            image: dockcross/linux-x64
            triple: x86_64-linux-gnu
          - name: ppc64le
            image: dockcross/linux-ppc64le
            triple: powerpc64le-linux-gnu

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Restore SDL cache (per-arch)
        uses: actions/cache@v4
        id: sdl-cache
        with:
          path: |
            .cache/sdl3-${{ matrix.name }}/install
            .cache/sdl3-${{ matrix.name }}/src
          key: sdl3-${{ matrix.name }}-v${{ env.SDL_VERSION }}-{{ runner.os }}-v1

      - name: Set up QEMU (for possible cross-container needs)
        uses: docker/setup-qemu-action@v2

      - name: Prepare dockcross wrapper script
        id: dockcross
        run: |
          set -eux
          echo "Creating dockcross wrapper for ${{ matrix.image }}"
          docker run --rm ${{ matrix.image }} > ./dockcross
          chmod +x ./dockcross
          echo "dockcross_path=./dockcross" >> $GITHUB_OUTPUT

      - name: Build SDL3 for ${{ matrix.name }}
        env:
          TRIPLE: ${{ matrix.triple }}
          ARCH_NAME: ${{ matrix.name }}
          SDL_URL: ${{ env.SDL_RELEASE_URL }}
          SDL_VERSION: ${{ env.SDL_VERSION }}
          CACHE_DIR: ${{ github.workspace }}/.cache/sdl3-${{ matrix.name }}
        run: |
          set -eux
          mkdir -p "${CACHE_DIR}"
          cd "${CACHE_DIR}"

          # If the source tarball isn't cached, fetch it
          if [ ! -f "SDL3-${SDL_VERSION}.tar.gz" ]; then
            echo "Downloading SDL ${SDL_VERSION}..."
            curl -L --retry 3 --retry-delay 2 -o "SDL3-${SDL_VERSION}.tar.gz" "${SDL_URL}"
          else
            echo "Using cached SDL tarball"
          fi

          # Extract into src/ if not already present
          if [ ! -d "src/SDL-"* ]; then
            mkdir -p src
            tar -xzf "SDL3-${SDL_VERSION}.tar.gz" -C src --strip-components=0
          fi

          # Find the extracted dir (stable name)
          SDL_SRC_DIR=$(find src -maxdepth 1 -type d -name "SDL3-*" -print -quit)
          if [ -z "$SDL_SRC_DIR" ]; then
            # older naming fallback
            SDL_SRC_DIR=$(find src -maxdepth 1 -type d -name "SDL-*" -print -quit)
          fi
          if [ -z "$SDL_SRC_DIR" ]; then
            echo "SDL source dir not found"
            exit 1
          fi

          # install prefix inside workspace so we can cache it
          INSTALL_PREFIX="${CACHE_DIR}/install"
          mkdir -p "${INSTALL_PREFIX}"

          echo "Building SDL from ${SDL_SRC_DIR} for ${TRIPLE} -> prefix ${INSTALL_PREFIX}"
          # cross-configure, build, and install using dockcross
          ./dockcross bash -lc "
            set -eux
            cd \"${GITHUB_WORKSPACE}/.cache/sdl3-${{ matrix.name }}/$(basename \"$SDL_SRC_DIR\")\"
            # configure the build for cross-compilation
            ./configure --host=${TRIPLE} --prefix=${INSTALL_PREFIX} \
                        --disable-tests --disable-video-opengl --disable-oss || true
            make -j\$(nproc) || ( echo 'Build failed, printing config.log and Makefile' && ls -la && tail -n +1 config.log || true ; false )
            make install
          "

      - name: Build vox8 using per-arch SDL
        env:
          PKG_CONFIG_PATH: ${{ github.workspace }}/.cache/sdl3-${{ matrix.name }}/install/lib/pkgconfig
          TRIPLE: ${{ matrix.triple }}
          ARCH_NAME: ${{ matrix.name }}
          DOCKCROSS: ${{ steps.dockcross.outputs.dockcross_path }}
        run: |
          set -eux
          # find nearest Makefile upward
          START_DIR="$(pwd)"
          SEARCH_DIR="$START_DIR"
          FOUND_MK=""
          while [ "$SEARCH_DIR" != "/" ] && [ -z "$FOUND_MK" ]; do
            if [ -f "$SEARCH_DIR/Makefile" ]; then
              FOUND_MK="$SEARCH_DIR"
              break
            fi
            SEARCH_DIR="$(dirname "$SEARCH_DIR")"
          done
          if [ -z "$FOUND_MK" ]; then
            echo "No Makefile found in parents. Exiting."
            exit 1
          fi
          echo "Using Makefile at: $FOUND_MK"

          # Create marker to help detect new files
          START_MARKER="${GITHUB_WORKSPACE}/.build_start_${ARCH_NAME}"
          touch "$START_MARKER"

          # Run make inside dockcross with PKG_CONFIG_PATH set so SDL is discovered
          ./dockcross bash -lc "set -eux; cd '$FOUND_MK'; \
            export PKG_CONFIG_PATH='${PKG_CONFIG_PATH}'; \
            export CFLAGS='-I${PKG_CONFIG_PATH%/lib/pkgconfig}/../include'; \
            export LDFLAGS='-L${PKG_CONFIG_PATH%/lib/pkgconfig}/../lib'; \
            echo 'PKG_CONFIG_PATH=' \$PKG_CONFIG_PATH; \
            make clean || true; \
            make -j\$(nproc) \
          "

          # Create artifacts directory
          ARTDIR="${GITHUB_WORKSPACE}/artifacts"
          mkdir -p "${ARTDIR}"

          # Collect newly created executable files newer than marker
          mapfile -t BUILT < <(find "$FOUND_MK" -type f -executable -newer "$START_MARKER" -print || true)
          for d in "$FOUND_MK/bin" "$FOUND_MK/build" "$FOUND_MK/dist" "$FOUND_MK/out" ; do
            if [ -d "$d" ]; then
              while IFS= read -r f; do BUILT+=("$f"); done < <(find "$d" -maxdepth 1 -type f -print || true)
            fi
          done

          if [ ${#BUILT[@]} -eq 0 ]; then
            echo "No newly built executables detected; packaging whole project tree (fallback)"
            tar -C "$FOUND_MK" -czf "${ARTDIR}/vox8-${ARCH_NAME}.tar.gz" .
          else
            echo "Packaging ${#BUILT[@]} files for ${ARCH_NAME}"
            # create a temporary packaging dir to preserve relative paths
            PKGDIR="${GITHUB_WORKSPACE}/.pkg_${ARCH_NAME}"
            rm -rf "$PKGDIR"
            mkdir -p "$PKGDIR"
            for f in "${BUILT[@]}"; do
              # preserve structure relative to project root (or just put all into bin/)
              cp --parents "$f" "$PKGDIR" || cp "$f" "$PKGDIR" || true
            done
            tar -C "$PKGDIR" -czf "${ARTDIR}/vox8-${ARCH_NAME}.tar.gz" .
          fi

      - name: Show artifact size
        run: ls -lh artifacts || true

      - name: Upload per-arch artifact
        uses: actions/upload-artifact@v4
        with:
          name: vox8-${{ matrix.name }}
          path: artifacts/vox8-${{ matrix.name }}.tar.gz

  release:
    name: Create Release & Upload Artifacts
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download all built artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts-down

      - name: List downloaded files
        run: ls -lah artifacts-down || true

      - name: Create or update GitHub Release and upload assets
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts-down/**/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Done
        run: echo "Release created/updated with vox8-<arch> artifacts âœ…"